# Cursor代码修改规范规则（增强版）

## 规则概述
**规则ID**: 300-000 | **分类**: 执行性规则 | **版本**: v1.1

本规则确保所有代码修改都遵循设计文档优先、风险可控、可回滚的原则，特别强调多次修改的路径追踪和回滚能力。

## 核心原则

### 1. 设计文档优先原则 【条款: 300-000-1】
- **强制要求**: 任何代码修改前必须先回溯相关设计文档
- **文档缺失处理**: 如设计文档缺失或不完整，必须先复述已知范围，人工确认后再修改
- **设计范围**: 优先在设计范围内修改，超出范围需充分论证

### 2. 修改范围自动分类机制 【条款: 300-000-2】

#### 2.1 自动范围识别流程
```
1. 搜索相关设计文档
2. 如文档缺失 → 复述已知范围 → 人工确认
3. 如文档不完整 → 分析代码结构 → 推断设计意图 → 人工确认
4. 如文档完整 → 直接分类
```

#### 2.2 修改范围分类（AI自动执行）
- **设计范围内修改**: 符合现有架构、接口、数据流
- **设计边界修改**: 涉及接口变更但保持向后兼容  
- **超出设计范围修改**: 改变架构、核心接口、数据模型

### 3. 简易风险评估矩阵（AI自动执行）【条款: 300-000-3】

#### 3.1 风险等级自动判定
```
低风险判定条件：
- 单个函数内部修改
- 不影响接口和数据流
- 仅修改实现细节

中风险判定条件：
- 模块内部修改
- 可能影响接口行为
- 需要更新接口文档

高风险判定条件：
- 跨模块修改
- 改变核心接口
- 影响数据模型

极高风险判定条件：
- 架构变更
- 核心算法变更
- 影响系统稳定性
```

#### 3.2 自动风险评估流程
```
1. 分析修改影响范围
2. 检查是否涉及接口变更
3. 评估是否影响数据流
4. 自动判定风险等级
5. 生成相应的审批要求
```

### 4. 多次修改路径追踪机制 【条款: 300-000-4】

#### 4.1 修改路径标记规范
```
修改路径格式：backup_YYYYMMDD_HHMMSS_修改描述_序号
示例：
- backup_20250827_103549_进度条修复_001
- backup_20250827_104500_信号连接优化_002
- backup_20250827_105000_UI响应性提升_003
```

#### 4.2 修改历史链构建
```
修改历史链结构：
修改001 → 修改002 → 修改003 → 当前状态
   ↓           ↓         ↓
备份001    备份002    备份003
   ↓           ↓         ↓
回滚点1    回滚点2    回滚点3
```

#### 4.3 回滚路径追踪
```
回滚操作支持：
- 回滚到修改001：使用备份001
- 回滚到修改002：使用备份002  
- 回滚到修改003：使用备份003
- 回滚到任意中间状态：组合使用多个备份
```

### 5. 非Git回滚机制（git提交前补充）【条款: 300-000-5】

#### 5.1 本地备份策略
```
备份目录结构：
backup_修改描述_YYYYMMDD_HHMMSS/
├── 修改前代码/
├── 修改后代码/
├── 修改说明.md
├── 影响分析.md
└── 回滚指南.md
```

#### 5.2 快速回滚操作
```
回滚操作步骤：
1. 选择目标回滚点
2. 复制备份代码到目标位置
3. 验证回滚结果
4. 记录回滚操作
```

## AI自动执行流程

### 阶段1: 自动分析阶段 【条款: 300-000-6】
```
AI自动执行：
1. 搜索相关设计文档
2. 分析代码结构
3. 自动判定修改范围
4. 自动评估风险等级
5. 生成分析报告
```

### 阶段2: 自动方案生成 【条款: 300-000-7】
```
AI自动执行：
1. 根据风险等级生成相应方案
2. 提供多个选择方案
3. 自动生成测试计划
4. 自动生成回滚计划
```

### 阶段3: 自动备份实施 【条款: 300-000-8】
```
AI自动执行：
1. 创建修改路径标记
2. 执行代码备份
3. 记录修改历史
4. 更新修改链
```

## 实际应用示例

### 示例：进度条修复问题
```
AI自动执行流程：
1. 搜索进度条相关设计文档 → 文档缺失
2. 分析代码结构 → 发现进度条实现
3. 自动判定：设计范围内修改
4. 自动评估：低风险
5. 自动生成：修复信号连接方案
6. 自动备份：backup_20250827_103549_进度条修复_001
7. 执行修改：修复信号连接
8. 记录历史：更新修改链
```

## 修改流程

### 阶段1: 分析阶段 【条款: 300-000-9】
1. **问题识别**: 明确要解决的问题
2. **设计文档回溯**: 查找相关设计文档
3. **影响分析**: 评估修改的影响范围
4. **风险评估**: 确定修改的风险等级

### 阶段2: 方案设计 【条款: 300-000-10】
1. **方案制定**: 根据风险等级制定相应方案
2. **方案评审**: 按风险等级进行相应审批
3. **测试计划**: 制定测试策略和用例
4. **回滚计划**: 制定回滚策略

### 阶段3: 实施阶段 【条款: 300-000-11】
1. **代码备份**: 按备份策略进行备份
2. **代码修改**: 按批准的方案实施
3. **测试验证**: 执行测试计划
4. **文档更新**: 更新相关文档

### 阶段4: 验证阶段 【条款: 300-000-12】
1. **功能验证**: 确认功能正常
2. **性能验证**: 确认性能无下降
3. **回归测试**: 确认无回归问题
4. **用户验收**: 获得用户确认

## 文档更新要求

### 设计文档更新 【条款: 300-000-13】
- **强制更新**: 架构变更、接口变更、数据模型变更
- **建议更新**: 实现细节变更、配置变更
- **更新内容**: 变更原因、变更内容、影响分析、兼容性说明

### 代码注释更新 【条款: 300-000-14】
- **函数级**: 修改函数的功能说明、参数说明、返回值说明
- **类级**: 修改类的职责说明、使用说明
- **模块级**: 修改模块的依赖关系、配置要求

## 违规处理

### 违规分类 【条款: 300-000-15】
- **轻微违规**: 未按流程备份代码
- **一般违规**: 超出设计范围但未充分论证
- **严重违规**: 未回溯设计文档直接修改
- **极严重违规**: 修改导致系统崩溃或数据丢失

### 处理措施 【条款: 300-000-16】
- **轻微违规**: 警告，要求补做
- **一般违规**: 暂停修改权限，要求重新设计
- **严重违规**: 撤销修改，恢复原代码
- **极严重违规**: 暂停开发权限，进行安全培训

## 工具支持

### AI自动执行工具 【条款: 300-000-17】
- **自动文档搜索**: 自动搜索相关设计文档
- **自动范围分析**: 自动分析修改影响范围
- **自动风险评估**: 自动评估修改风险等级
- **自动备份管理**: 自动管理多次修改的备份

### 修改路径追踪工具 【条款: 300-000-18】
- **修改历史链**: 自动构建修改历史链
- **回滚路径**: 自动生成回滚路径
- **状态恢复**: 支持恢复到任意历史状态

### 自动化工具 【条款: 300-000-19】
- **Git集成**: 自动创建分支和标签
- **代码审查**: 集成代码审查工具
- **测试自动化**: 自动执行测试用例
- **文档生成**: 自动生成修改报告

### 监控工具 【条款: 300-000-20】
- **代码质量**: 代码复杂度、覆盖率监控
- **性能监控**: 响应时间、资源使用监控
- **错误监控**: 异常、错误率监控
- **用户反馈**: 用户满意度、问题反馈监控

## 持续改进

### 规则更新 【条款: 300-000-21】
- **定期评估**: 每季度评估规则有效性
- **问题收集**: 收集使用过程中的问题
- **规则优化**: 根据问题优化规则
- **培训更新**: 更新相关培训材料

### 最佳实践 【条款: 300-000-22】
- **案例收集**: 收集成功的修改案例
- **经验总结**: 总结修改经验和教训
- **知识分享**: 在团队内分享最佳实践
- **工具优化**: 根据使用反馈优化工具

## 附录

### A. 修改申请模板
```
修改申请单
├── 问题描述
├── 影响分析
├── 风险评估
├── 修改方案
├── 测试计划
├── 回滚计划
└── 审批记录
```

### B. 回滚操作指南
```
回滚操作步骤
├── 确认回滚原因
├── 选择回滚策略
├── 执行回滚操作
├── 验证回滚结果
└── 记录回滚过程
```

### C. 风险评估检查清单
```
风险评估检查项
├── 功能影响范围
├── 性能影响程度
├── 兼容性影响
├── 安全性影响
└── 维护性影响
```

### D. 修改路径追踪模板
```
修改路径记录
├── 修改ID: backup_YYYYMMDD_HHMMSS_修改描述_序号
├── 修改时间: YYYY-MM-DD HH:MM:SS
├── 修改者: 开发者姓名
├── 修改原因: 问题描述
├── 修改内容: 具体修改内容
├── 影响分析: 修改影响范围
├── 风险评估: 风险等级和原因
├── 备份位置: 备份文件路径
├── 回滚指南: 回滚操作步骤
└── 验证结果: 修改后验证结果
```

---

**规则制定者**: LAD开发团队  
**规则生效日期**: 2025-08-27  
**规则版本**: v1.1  
**下次评估日期**: 2025-11-27 