# 013 测试门控与运行指南

本指南固化 013 相关分组用例的门控与运行方法，避免遗忘。适用于本地与 CI。

## 门控变量与环境设置

- LAD_RUN_013_TESTS=1
  - 解禁 013 分组用例（默认不启用）。
- QT_QPA_PLATFORM=offscreen
  - 无头/CI 环境下运行 PyQt。
- QT_LOGGING_RULES="*.debug=false;qt.qpa.*=false;qt.text.*=false;qt.fonts.*=false"
  - 降低 Qt 控制台噪声，避免干扰日志。
- 备注
  - 个别 Qt 运行时提示（例如 “This plugin does not support createPlatformOpenGLContext!”）可能直接经由底层插件写入 stderr，不属于 Python warnings，不受 `-W error` 影响；通常可忽略。

## 在 CI 中使用（示例）

GitHub Actions（Windows）示例：

```yaml
jobs:
  test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: pip install -r local_markdown_viewer/requirements.txt
      - name: Run tests with 013 gated on
        shell: pwsh
        run: ./local_markdown_viewer/run_pytests.ps1 -Enable013
```

或直接设置环境变量运行：

```powershell
$env:LAD_RUN_013_TESTS="1"; $env:LAD_TEST_MODE="1";
$env:QT_QPA_PLATFORM="offscreen";
$env:QT_LOGGING_RULES="*.debug=false;qt.qpa.*=false;qt.text.*=false;qt.fonts.*=false";
python -u -m pytest -vv -W error -s
```

## 本地快速验证

- 常规回归（启用 013）：

```powershell
./run_pytests.ps1 -Enable013
```

- 全模式关键用例（启用 013）：

```powershell
./scripts/run_full_mode_tests.ps1 -Enable013
```

- 直接一次性设置环境变量并运行（不经过脚本）：

```powershell
$env:LAD_RUN_013_TESTS="1"; $env:LAD_TEST_MODE="1"; $env:QT_QPA_PLATFORM="offscreen";
$env:QT_LOGGING_RULES="*.debug=false;qt.qpa.*=false;qt.text.*=false;qt.fonts.*=false";
python -u -m pytest -vv -W error -s tests/test_link_processor_external.py
```

## 参考

- `tests/conftest.py` 会话级统一初始化：自动构造 `QApplication([])`、设置 `offscreen` 与 `QT_LOGGING_RULES`。
- `run_pytests.ps1` 与 `scripts/run_full_mode_tests.ps1` 支持 `-Enable013`，并统一设置无头与降噪参数。
