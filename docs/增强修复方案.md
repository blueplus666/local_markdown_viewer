# 本地Markdown渲染器 增强修复方案（导入一致性与可观测性）

## 目标
- 统一不同解释器/运行入口的模块导入行为，确保始终命中 `lad_markdown_viewer/markdown_processor.py`。
- 明确区分“目标模块导入成功”“fallback 成功”和“失败”，提升日志与状态栏可观测性与一致性。
- 在 Importer 层完成函数映射完整性校验，避免 Renderer 二次判断带来的语义误差。

---

## A. 环境与路径配置（优先可落地）

### A1. 配置 Importer 的 external module 路径（推荐）
- **配置文件位置**: `config/external_modules.json`
- **external_modules.json为唯一事实来源**：所有模块配置信息以该文件为准，app_config.json中的external_modules部分应保持为空
- **配置格式示例**:
```json
{
  "external_modules": {
    "markdown_processor": {
      "enabled": true,
      "module_path": "D:\\lad\\LAD_md_ed2\\lad_markdown_viewer",
      "version": "1.0.0",
      "priority": 1,
      "required_functions": [
        "render_markdown_with_zoom",
        "render_markdown_to_html"
      ],
      "fallback_enabled": true
    }
  }
}
```
- **配置文件创建**: 如果文件不存在，应用会自动创建默认配置
- **配置验证**: 启动时会验证配置文件格式和必需字段
- **配置冲突解决**: 通过 `core/config_validator.py` 自动检测和解决配置冲突
- **验证方法**: 
  1. 启动应用后检查日志中的"动态导入markdown_processor成功"
  2. 检查状态栏显示"✅ Markdown处理器已加载（动态导入）"
  3. 打开Markdown文件验证渲染功能正常
- **预期效果**: `DynamicModuleImporter` 使用临时 `sys.path` 从上述目录导入目标模块，返回函数映射
- **适用范围**: 所有解释器与启动路径
- **故障排除**: 如果路径不存在或权限不足，会在日志中记录详细错误信息

### A2. 备选方案（任选其一，视团队偏好）
- 设置系统/用户环境变量 `PYTHONPATH= D:\lad\LAD_md_ed2`。
- 在 `LAD_md_ed2` 根目录执行可编辑安装（若存在构建脚手架）：`pip install -e .`，使 `lad_markdown_viewer` 成为全局可见包。

---

## B. 逻辑优化（Importer 与 Renderer 协同）

### B1. Importer裁决口径（新增）
- **Importer裁决权**：模块可用性只由 `core/dynamic_module_importer.py` 判定；Renderer尊重Importer的裁决结果
- **裁决标准**：仅当"拿到完整函数映射"才标记 `success=True`：
  - 函数映射必须同时包含并可调用：`render_markdown_with_zoom`、`render_markdown_to_html`。
  - 否则：
    - `success=False`
    - `error_code=MISSING_SYMBOLS`
    - `message='缺少必要的渲染函数'`
- **字段命名一致**：所有状态字段使用统一命名规范：
  - `function_mapping_status`: "complete" | "incomplete" | "import_failed"
  - `required_functions`: 必需函数列表
  - `available_functions`: 可用函数列表
  - `missing_functions`: 缺失函数列表
  - `non_callable_functions`: 不可调用函数列表
- **明确 fallback 语义**：
  - 当 fallback 到 `markdown` 库时：
    - `module='markdown'`
    - `used_fallback=True`
    - `success=True`（表示"有可用替代模块"），但不提供 `functions`（或留空）。
- **返回结果应包含**：`module`, `path`（若可获取）, `used_fallback`, `functions`（仅目标模块提供）。

### B2. Renderer（`core/markdown_renderer.py`）
- 判定动态导入可用的条件：
  - 仅当 `module=='markdown_processor'` 且函数映射齐全可调用时，认为“动态导入成功且可用于渲染”。
  - 若 Importer 返回 `used_fallback=True` 或 `module!='markdown_processor'`，跳过动态导入路径，直接进入备用 `markdown` 库分支。
- 日志与错误：
  - 在动态导入分支失败时，打印可用 `available_keys`、`module`、`used_fallback`、`path` 等，便于定位。
  - 在回退到 `markdown` 库时，INFO 打印“已回退至内置 markdown”，包含扩展列表与是否附加基础样式。

---

## C. UI 与状态栏一致性
- **状态栏数据来源=状态管理器快照**：UI和日志只读"状态管理器最新快照"；UI不做推断
- **状态管理器集成**：通过 `core/application_state_manager.py` 统一管理所有应用状态
- **快照系统**：通过 `core/snapshot_manager.py` 实现状态的持久化和恢复
- 现状：`main.py` 的 `check_import_status()` 仅使用 `find_spec` 做"轻量探测"，与 Renderer 的真实运行态可能不一致（会误显示"备用库"）。
- 调整建议：
  - 在主窗口显示后，从状态管理器的实际快照更新状态栏。
  - 展示文案建议：
    - 成功（目标模块）：`✅ Markdown处理器已加载（动态导入）`
    - fallback：`⚠️ 使用备用Markdown库（fallback）`
    - 纯文本：`❌ Markdown处理器不可用（纯文本降级）`

---

## D. 可观测性与日志补强
- Importer：
  - 统一在返回结果中包含：`module`, `path`, `used_fallback`, `error_code`（如有）。
  - 对 fallback 情况打印“fallback 命中”的 INFO 日志（含目标 fallback 名与原因）。
- Renderer：
  - 在选择分支时，记录所用分支、导入结果关键字段与最终渲染器类型（`markdown_processor` / `markdown_library` / `text_fallback`）。
  - 回退/降级路径输出一次性结构化日志，便于快速 grep。

---

## E. 验证与自测（可复制运行）

### E1. 函数映射与路径自测（解释器无关）
```python
from local_markdown_viewer.core.dynamic_module_importer import DynamicModuleImporter
imp = DynamicModuleImporter()
res = imp.import_module('markdown_processor', ['markdown'])
print('module=', res.get('module'), 'path=', res.get('path'), 'used_fallback=', res.get('used_fallback'))
funcs = res.get('functions', {})
print('keys=', list(funcs.keys()))
print('callables=', {k: callable(v) for k, v in funcs.items()})
```
- 期望（目标模块）：`module=markdown_processor`，包含两函数且均为 `True`，`used_fallback=False`。
- 期望（fallback）：`module=markdown`，`used_fallback=True`，`functions` 为空或缺失。

### E2. 直接导入路径确认
```python
import sys, importlib
sys.path.insert(0, r'D:\lad\LAD_md_ed2')
mp = importlib.import_module('lad_markdown_viewer.markdown_processor')
print('mp.file=', getattr(mp, '__file__', None))
print('has_zoom=', hasattr(mp, 'render_markdown_with_zoom'))
print('has_html=', hasattr(mp, 'render_markdown_to_html'))
```
- 期望：文件路径指向 `lad_markdown_viewer/markdown_processor.py` 且两个函数为 `True`。

### E3. 运行态验证（应用内）
- 启动应用，打开 2–3 个 Markdown 文件（含 mermaid 与图片的文档）。
- 检查日志：
  - 不再出现 `available_keys=[]` 或 KeyError；
  - 若命中 fallback，日志明确“fallback 命中，使用内置 markdown 库”。
- 检查状态栏：与实际使用的渲染分支一致。

---

## F. 变更点汇总（实施清单）
1) 配置：将 `markdown_processor.module_path` 指向 `D:\lad\LAD_md_ed2\lad_markdown_viewer`。
2) Importer：
   - 函数映射完整性校验，不完整则 `success=False / MISSING_SYMBOLS`。
   - fallback 明确标记：`module='markdown'`, `used_fallback=True`。
   - 实现Importer裁决口径，统一字段命名规范。
3) Renderer：
   - 仅当 `module=='markdown_processor'` 且函数映射齐全时走动态导入分支。
   - 回退/降级路径增加 INFO 结构化日志。
4) UI：状态栏改为读取状态管理器快照更新文案。
5) 新增模块：
   - 创建 `core/application_state_manager.py` 统一状态管理
   - 创建 `core/snapshot_manager.py` 快照管理
   - 创建 `core/config_validator.py` 配置验证
   - 创建 `core/performance_metrics.py` 性能监控
6) 自测：按 E 节脚本 + 应用运行验证一致性。

---

## G. 回滚与风险控制

### G1. 风险评估
- **变更性质**: 变更均为"增加判断与日志、修正文案"，风险较低
- **影响范围**: 仅影响模块导入和状态显示，不影响核心渲染功能
- **回滚复杂度**: 低，主要为配置文件修改

### G2. 回滚方案
- **快速回滚**: 
  1. 在 `config/external_modules.json` 中设置 `"enabled": false`
  2. 重启应用验证回滚效果
- **完整回滚**: 
  1. 恢复备份的配置文件：`cp config/external_modules.json.backup config/external_modules.json`
  2. 重启应用并验证功能
- **应急回滚**: 
  1. 如出现异常，可临时在配置中关闭 `use_dynamic_import`
  2. 系统将直接使用内置 `markdown` 渲染
  3. 在日志中记录应急回滚原因

### G3. 回滚验证步骤
1. **功能验证**: 打开多个Markdown文件，确认渲染正常
2. **状态验证**: 检查状态栏显示"⚠️ 使用备用Markdown库（fallback）"
3. **日志验证**: 确认日志中显示"已回退至内置 markdown"
4. **性能验证**: 确认应用响应速度正常

### G4. 风险监控
- **实时监控**: 应用启动后前5分钟密切关注日志输出
- **功能监控**: 测试各种类型的Markdown文件渲染
- **性能监控**: 监控内存使用和响应时间
- **错误监控**: 设置错误告警，及时发现问题

---

## H. 预期收益
- 不同解释器与入口的一致性显著增强。
- 日志与状态栏与真实运行态一致，便于排错与审计。
- 失败路径更可控，避免"看似成功实则回退"的混淆。

---

## I. 统一状态管理与快照系统（新增）

### I1. 状态管理器架构
- **ApplicationStateManager**：统一应用状态管理器，负责管理所有应用状态
- **状态类型**：
  - 模块状态：`module_import_snapshot`
  - 渲染状态：`render_snapshot`
  - 链接状态：`link_snapshot`（为链接功能预留）
- **状态来源单一**：UI和日志只读"状态管理器最新快照"；UI不做推断

### I2. 快照系统
- **SnapshotManager**：快照管理器，通过 `core/unified_cache_manager.py` 持久化
- **快照类型**：
  - `render_snapshot`：渲染决策后写入
  - `module_import_snapshot`：导入尝试后写入（成功/失败都写）
  - `link_snapshot`：链接事件回调后写入
- **生命周期**：刷新=重算并覆盖

### I3. 配置冲突检测与处理
- **ConfigValidator**：配置验证器，检测和解决配置冲突
- **冲突解决策略**：external_modules.json优先级高于app_config.json
- **启动时检查**：自动检测冲突并应用解决策略

### I4. 错误码标准化
- **模块导入错误码**：PATH_INVALID、IMPORT_ERROR、MISSING_SYMBOLS等
- **链接处理错误码**：POLICY_BLOCKED、ACL_DENIED、INVALID_URL等
- **渲染处理错误码**：RENDERER_NOT_AVAILABLE、CONTENT_EMPTY等
- **错误消息映射**：每个错误码对应标准化的错误消息

### I5. 性能监控与指标
- **PerformanceMetrics**：性能指标收集器
- **监控维度**：
  - 导入性能：导入时间、成功率、缓存命中率
  - 渲染性能：渲染时间、文件大小、缓存效果
  - 链接性能：链接处理时间、成功率、策略违规
  - UI性能：响应时间、状态更新延迟
  - 系统性能：内存使用、CPU使用、缓存大小

---

## J. 后续完善计划（暂不在此次实施范围内）

### J1. 性能影响评估
- 函数映射完整性校验的性能影响分析
- 状态栏实时更新的性能影响评估
- 日志增加的存储影响评估
- 缓存机制的性能优化

### J2. 兼容性考虑
- 对现有配置文件的向后兼容性保证
- 对旧版本应用的兼容性处理
- 对不同的Python版本兼容性测试
- 跨平台兼容性验证

### J3. 测试覆盖范围扩展
- 边界情况测试（空文件、损坏文件、权限问题等）
- 并发访问测试（多文件同时渲染）
- 长时间运行测试（内存泄漏、缓存失效等）
- 压力测试和性能基准测试

