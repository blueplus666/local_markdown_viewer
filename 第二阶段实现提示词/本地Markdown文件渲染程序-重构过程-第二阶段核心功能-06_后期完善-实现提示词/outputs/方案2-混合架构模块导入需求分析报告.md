# 混合架构模块导入需求分析报告

## 1. 背景与目标
为兼顾灵活性与稳定性，采用“方案B：混合架构（Hybrid）”。目标是在不修改现有可用功能前提下，定义一套由动态模块导入与统一路径解析协同工作的能力边界、配置契约与可观测性要求，为后续设计与实施提供明确输入。

- 当前现状（摘录）：
  - `core/markdown_renderer.py` 采用统一路径解析（依赖 `core/file_resolver.py`），优先使用 `python-markdown` 库，失败时降级纯文本；未实现动态导入外部 `markdown_processor`。
  - `config/app_config.json` 中存在 `external_modules.markdown_processor` 与 `markdown.module_path` 配置，但现有渲染流程未利用动态导入。
  - UI 与入口：`main.py`、`ui/content_viewer.py`、`ui/file_tree.py`、`main_window*.py` 均可正常加载当前渲染流程。

- 本报告仅输出分析，不改动任何代码或非本步骤要求的文档。

## 2. 架构要点与约束
- DynamicModuleImporter（动态导入器）需求与接口边界：
  - 能力要求：
    - 导入策略：优先从配置的模块路径尝试；失败则转入受控 fallback 列表（如标准 `markdown` 库）。
    - 多路径支持：仅读取 `external_modules.*`；支持相对/绝对路径解析。
    - 结果缓存：对成功的导入结果进行进程级缓存，避免重复 `sys.path` 变更与重复 IO。
    - 临时路径注入：对 `sys.path` 的修改需具备“进入-退出”成对控制，确保不污染全局环境。
    - 错误可观测：返回结构化结果（success/false、error_code、message、attempted_paths、used_fallback、module_name、resolved_path）。
    - 功能探测：对 `markdown_processor` 至少探测 `render_markdown_with_zoom` 与 `render_markdown_to_html` 的可用性。
  - 建议接口：
    - `import_module(module_name: str, fallback_modules: list[str] = None) -> dict`
    - `clear_cache() -> None`
    - `get_import_status() -> dict`（展示缓存模块、配置路径、最近错误等）
  - 边界约束：
    - 仅允许导入在配置中声明且启用的模块；对路径进行存在性与可读性检查。
    - 可选加入路径白名单/前缀校验（如仅允许工作区内或配置的受信根目录）。

- FileResolver（统一路径解析）职责与最小交互：
  - 职责保持：文件存在性校验、大小限制、编码探测、读取内容、类型识别、统一错误返回结构。
  - 与动态导入器的关系：两者解耦。FileResolver 不参与 Python 包导入，只负责文件路径与内容层面的统一解析。
  - 最小接口依赖（供渲染器使用）：`resolve_file_path(file_path, options)`，以及元数据获取方法（编码、类型、大小等）。

- HybridMarkdownRenderer（混合渲染器）能力检测、优先级与降级链：
  - 能力检测：
    - 若配置开启 `markdown.use_dynamic_import == true`，优先通过 DynamicModuleImporter 尝试 `markdown_processor`。
    - 若失败，则尝试标准 `markdown` 库；再失败则降级纯文本（受 `markdown.fallback_enabled` 控制）。
  - 优先级链：`markdown_processor` > `python-markdown` > `text_fallback`。
  - 选项扩展（在保持向后兼容前提下）：新增 `use_dynamic_import`（默认 true），其余沿用当前 `markdown_renderer` 既有选项（如 `enable_zoom`、`cache_enabled` 等）。
  - 可观测性：在初始化与渲染阶段记录所用渲染器、耗时、失败原因、降级决策。

## 3. 配置项与验证
- external_modules.*（以 `markdown_processor` 为例）：
  - 必需字段：
    - `module_path: string`（可相对/绝对路径）
    - `enabled: boolean`
  - 可选字段：`version: string`、`description: string`、`priority: number`
  - 验证规则：
    - 当 `enabled == true` 时，`module_path` 必须存在且可读；
    - 期望在 `module_path` 可导入 `markdown_processor` 包/模块，并包含函数：`render_markdown_with_zoom`、`render_markdown_to_html`；
    - 失败处置：记录结构化错误并回退到 fallback。

- markdown.*：
  - 关键字段：
    - `use_dynamic_import: boolean`（默认 true）
    - `fallback_enabled: boolean`（默认 true）
    - `cache_enabled: boolean`（默认 true）
    - `max_content_length: number`（默认 5MB，已在现有实现中使用）
  - 验证规则：
    - 对 `max_content_length` 做下限与上限保护（防止意外大值引发 OOM）。

- 失败与回退策略：
  - 动态导入失败：记录错误 → 尝试标准 `markdown` → 失败则依 `fallback_enabled` 降级纯文本 → 最终失败抛出统一异常并返回错误 HTML。
  - 配置缺失：采用默认值并发出告警日志；涉及安全边界的缺失（如未知路径）则直接禁用动态导入。

## 4. 资料与数据流
- 本步骤产出（本地文件化）：
  - 本报告：`第二阶段实现提示词/.../outputs/混合架构模块导入需求分析报告.md`
- 后续步骤输入契约（需本地可读，不依赖口头上下文）：
  1) 《DynamicModuleImporter 设计说明》：
     - API 与返回结构定义、错误码表、日志键规范、sys.path 上下文管理策略、缓存键策略。
  2) 《HybridMarkdownRenderer 设计与集成方案》：
     - 与现有 `MarkdownRenderer` 的关系（替换或增量并存）、配置读取与能力检测流程、降级链实现细节、计时与缓存复用策略。
  3) 《配置校验与回退策略说明》：
     - external_modules 与 markdown 段落的必填/可选、默认值、校验失败时的处置矩阵。

## 5. 兼容性与改动范围
- 不改动与方案无关代码：本步骤不进行任何代码修改。
- 预计改动最小化建议（供后续阶段参考）：
  - 新增 `DynamicModuleImporter` 独立模块文件（不侵入现有解析器与渲染器）。
  - 在不破坏现有行为的前提下，为渲染器增加可选分支（或新增 `HybridMarkdownRenderer` 并在 UI 层通过依赖注入切换）。
  - `ConfigManager` 仅在需要时补充对 `use_dynamic_import` 的安全读取与默认值提供，保持向后兼容。
- 对现有功能影响评估：
  - 默认开启动态导入但失败即回退，不影响基本渲染路径；
  - 新增日志与错误返回字段不改变现有 UI 显示结构，可按需在状态栏/日志窗口中展示。

## 6. 风险与缓解
- 依赖丢失/路径异常：
  - 预检测 `module_path` 存在性；导入失败结构化记录并回退。
- sys.path 污染与线程安全：
  - 使用上下文管理器临时注入并立即恢复；UI 主线程场景下不引入并发修改。
- 性能与冷启动：
  - 首次导入可能有路径解析与 I/O 开销；通过缓存结果、避免重复解析，将影响控制在首次使用。
- 可信边界与安全：
  - 路径白名单/前缀限制（例如限制到工作区或受信根）；拒绝从未声明路径导入。
- 可观测性与排障：
  - 统一日志键（module_name、resolved_path、attempted_paths、fallback_used、elapsed_ms、error_code）。

- 热切换成本：
  - 触发场景：修改 `external_modules.*` 或 `markdown.use_dynamic_import` 后生效。
  - 策略：不即时重载，延迟至“下一次渲染调用”生效；提供 `clear_cache()` 手动触发重新探测；必要时在 UI 提供“刷新渲染器”入口。
  - 成本控制：仅首轮探测发生路径解析与导入；使用临时 `sys.path` 上下文并立即恢复；成功后结果进入导入缓存避免重复开销。
  - 可观测性：记录切换事件（old_renderer → new_renderer）、尝试路径、耗时与回退决策，便于审计与排障。

---

下一步所需关键数据摘要：
- API：`DynamicModuleImporter.import_module(name, fallback_modules) -> { success, module/functions, used_fallback, path, error }`
- 必要函数探测：`render_markdown_with_zoom`、`render_markdown_to_html`
- 配置键：
  - `external_modules.markdown_processor.enabled|module_path|version|description|priority`
  - `markdown.use_dynamic_import|fallback_enabled|cache_enabled|max_content_length`
- 日志键与错误码：需在设计说明中固化（建议含 PATH_NOT_FOUND / IMPORT_ERROR / MISSING_SYMBOLS / FALLBACK_USED）。
- 兼容性策略：失败即回退；默认值完整；不破坏现有 UI 套件。