# 链接处理模块设计

**生成时间**: 2025-08-14 16:07:46  
**依据资料**: `方案3-链接处理需求分析报告.md`、`markdown_renderer.py`、`content_preview.py`、`dynamic_module_importer.py`、`content_viewer.py`、`lad_markdown_viewer/markdown_processor.py`  
**平台范围**: Windows（ACL 权限与盘符路径语义）  
**架构基线**: 混合架构（FileResolver + DynamicModuleImporter + HybridMarkdownRenderer）

---

## 1. 模块架构设计

### 1.1 模块定位
- 文件: `core/link_processor.py`（新建）
- 职责: 统一处理 Markdown 内部产生的各类链接请求，完成识别、解析、验证与路由，提供结果给上层 UI/业务。
- 设计目标:
  - 覆盖链接类型: 锚点、外部 http/https、相对路径、本地 file://、图片、Mermaid 图表、目录（TOC）项。
  - 与既有渲染与解析链条解耦，通过清晰接口接入。
  - Windows 优先：盘符、反斜杠、ACL 权限校验、无权限友好提醒与日志。

### 1.2 关键参与者与关系
- `LinkProcessor`(核心): 对外门面，聚合识别器、解析器、验证器、处理器，提供统一 `process_link()` 能力。
- `LinkTypeRecognizer`(识别器): 基于 href/上下文判断类型（anchor/http/relative/file/image/mermaid/toc）。
- `PathResolver`(解析器): 基于 `FileResolver` 完成相对/绝对/file:// 解析与标准化（Windows）。
- `LinkValidator`(验证器): 路径存在性、协议白名单、ACL 权限、禁止模式等校验。
- `LinkRouter`(路由器): 将不同类型链接分派到具体处理器（如 ExternalHandler、FileHandler、AnchorHandler 等）。
- `Policy`(策略集合): 来源于配置 `link_processing.*`（安全、日志、Windows 特定配置）。
- 现有组件交互:
  - 与 `HybridMarkdownRenderer`/`markdown_processor` 的事件衔接：接收 `ladMarkdownLinkClick` 事件数据。
  - 与 `FileResolver`：统一路径解析与文件元信息获取。
  - 与 `ContentViewer`：在需要 UI 行为（如打开目录、刷新视图、错误提示）时回调/发信号。

### 1.3 时序概览（点击外链示例）
1) 用户点击渲染结果中的链接 → 组件内脚本阻止默认行为并抛出 `ladMarkdownLinkClick` 事件（含 href）。  
2) 上层捕获事件并调用 `LinkProcessor.process_link(context)`。  
3) 识别器判定类型 → 解析器标准化路径/URL → 验证器按策略校验。  
4) 路由器调用具体处理器：
   - 外部链接 → 默认浏览器打开或交由系统处理。
   - 相对/本地 Markdown → post 出目标交由“官方程序/左侧树”处理。
   - 图片/图表 → 调用图像/图表显示组件或内部放大器逻辑的二次处理接口。
   - 锚点 → 内部滚动定位（无需外派）。
5) 记录访问/权限/错误日志 → 返回统一结果给调用方。

### 1.4 配置与策略（摘要）
- `link_processing.enabled`: 总开关
- `link_processing.relative_paths|external_links|image_links|mermaid_links|file_protocol`: 类型开关
- `link_processing.security.allowed_protocols|allowed_domains|forbidden_patterns`
- `link_processing.windows_specific.drive_letters|path_separator|max_path_depth`
- `link_processing.logging.enabled|level|permission_errors|access_logs`

### 1.5 错误与权限基线
- 权限不足: 统一友好提示（UI/日志同向），返回 `PERMISSION_DENIED`。
- 解析失败/不存在: 返回 `RESOLVE_ERROR`/`NOT_FOUND`，含建议与上下文。
- 协议/白名单拒绝: 返回 `SECURITY_BLOCKED`。
- 任何异常均落日志（按级别），不崩溃 UI。

---

## 2. 核心类和方法设计

> 仅定义接口与职责，不给出实现代码。

### 2.1 数据模型与枚举
- `enum LinkType { ANCHOR, EXTERNAL_HTTP, RELATIVE_MD, FILE_PROTOCOL, IMAGE, MERMAID, TOC, DIRECTORY, UNKNOWN }`
- `enum ErrorCode { OK, RESOLVE_ERROR, NOT_FOUND, PERMISSION_DENIED, SECURITY_BLOCKED, UNSUPPORTED, INTERNAL_ERROR }`
- `class LinkContext`
  - fields: `href: str`, `current_file: Path`, `current_dir: Path`, `source_component: str`, `extra: dict`
- `class ValidationResult`
  - fields: `ok: bool`, `error_code: ErrorCode`, `message: str`, `details: dict`
- `class LinkResult`
  - fields: `success: bool`, `action: str`, `payload: dict`, `message: str`, `error_code: Optional[ErrorCode]`

### 2.2 LinkProcessor（门面）
- ctor: `(config_manager: ConfigManager, file_resolver: FileResolver, logger)`
- `process_link(ctx: LinkContext) -> LinkResult`
  - 流程: 识别 → 解析 → 验证 → 路由 → 日志
- `set_handlers(handlers: dict[LinkType, ILinkHandler])`
- 内部辅助：`_recognize(ctx)`, `_resolve(ctx, link_type)`, `_validate(resolved, link_type)`, `_route(link_type, resolved)`, `_log(event)`

### 2.3 LinkTypeRecognizer（识别器）
- `recognize(href: str, context: LinkContext) -> LinkType`
- 识别规则（示例）：
  - `href.startswith('#')` → ANCHOR
  - `href.startswith('http://') or href.startswith('https://')` → EXTERNAL_HTTP
  - `href.startswith('file:///') or /^[A-Za-z]:\\/` → FILE_PROTOCOL（Windows）
  - `href.lower().endswith(('.png','.jpg','.jpeg','.gif','.svg','.webp'))` → IMAGE
  - `href.lower().endswith('.md')` 且非 http/file → RELATIVE_MD
  - `'#' in href` 与标题 slug 匹配 → TOC（目录项）
  - 根据渲染容器内选择器命中 `.mermaid` 邻接关系 → MERMAID（如从事件 extra 指明）
  - 以`/`或`\\`结尾，或无扩展名且解析结果为目录 → DIRECTORY（文件夹目录链接）

### 2.4 PathResolver（解析器）
- 依赖 `FileResolver`
- `resolve_relative(current_file: Path, href: str) -> Path`
- `resolve_file_protocol(url: str) -> Path`（处理 `file:///C:/...`）
- `normalize_windows_path(path: Path) -> Path`（盘符、反斜杠、冗余段处理）

### 2.5 LinkValidator（验证器）
- 协议与域名：`validate_protocol(url)`, `validate_domain(url, allowed_domains)`
- 路径与存在性：`validate_exists(path)`, `validate_depth(path, max_depth)`
- 安全规则：`validate_forbidden(path, patterns)`
- Windows 权限：`validate_acl(path) -> ValidationResult`
- 组合校验：`validate(resolved, policy) -> ValidationResult`

### 2.6 处理器（Handlers）接口
- `interface ILinkHandler { handle(ctx, resolved) -> LinkResult }`
- `AnchorHandler`：在当前 Web 视图内滚动定位（不向外派发）。
- `ExternalHandler`：外部 http/https → 默认浏览器打开。
- `RelativeMarkdownHandler`：相对/同仓本地 `.md` → post 目标路径给“官方程序/左树”打开。
- `FileHandler`：`file://` 与绝对路径 → 权限与存在性校验后交由系统处理或反馈错误。
- `ImageHandler`：图片 → 交给图像组件/放大器。
- `MermaidHandler`：图表 → 二次放大/独立视窗查看（可复用现有脚本能力）。
- `TocHandler`：目录项 → 定位到对应锚点（与 Anchor 合流）。
- `DirectoryHandler`：目录链接 → 通知“官方程序/左侧树”打开并选中该目录。

### 2.7 Policy（策略）与 Config 绑定
- 来自 `ConfigManager`：`link_processing.*`
- 关键键位：
  - `enabled`
  - `relative_paths|external_links|image_links|mermaid_links|file_protocol`
  - `security.allowed_protocols|allowed_domains|forbidden_patterns`
  - `windows_specific.drive_letters|path_separator|max_path_depth`
  - `logging.enabled|level|permission_errors|access_logs`

### 2.8 Logging（日志）
- 记录项：时间、会话ID `session_id`（来自会话规范）、用户操作、href、结果、错误码、ACL 详情（权限不足时）。
- 级别：INFO（访问）、WARNING（策略拒绝/不存在）、ERROR（异常/权限）。

### 2.9 校验顺序规范（用于相对/文件/目录处理器）
- 1) 路径标准化（盘符、反斜杠、冗余段）
- 2) 目标存在性检查（文件/目录）
- 3) 深度/禁止模式检查（`max_path_depth`、`forbidden_patterns`）
- 4) ACL 权限校验（无权限→友好提示+详细日志）

---

## 3. 接口定义（对外 API）

### 3.1 LinkProcessor
- `process_link(ctx: LinkContext) -> LinkResult`
  - 输入：
    - `href`（字符串）
    - `current_file`（Path）
    - `source_component`（如 `ContentViewer`）
    - `extra`（事件附带信息：是否来自图片/mermaid 容器等）
  - 输出：
    - `success: bool`
    - `action: str`（open_browser|open_markdown_in_tree|open_directory|scroll_to_anchor|open_image_viewer|show_error 等）
    - `payload: dict`（路径/URL/锚点/提示文案）
    - `message: str`
    - `error_code: ErrorCode|None`
  - 最小返回示例（联调用）：
    ```json
    { "success": true, "action": "open_markdown_in_tree", "payload": { "path": "D:\\docs\\a.md" }, "message": "", "error_code": null }
    ```

### 3.2 Handlers（典型）
- `ExternalHandler.handle(ctx, resolved_url) -> LinkResult`
- `RelativeMarkdownHandler.handle(ctx, resolved_path) -> LinkResult`
- `FileHandler.handle(ctx, resolved_path) -> LinkResult`
- `AnchorHandler.handle(ctx, anchor_id) -> LinkResult`
- `ImageHandler.handle(ctx, resolved)` / `MermaidHandler.handle(...)`

### 3.3 验证/解析接口
- `PathResolver.resolve_relative(current_file, href) -> Path`
- `PathResolver.resolve_file_protocol(url) -> Path`
- `LinkValidator.validate(resolved, policy) -> ValidationResult`

### 3.4 结果与错误语义
- `OK`：`success=True, error_code=None`
- `RESOLVE_ERROR/NOT_FOUND`：解析失败/目标不存在
- `PERMISSION_DENIED`：ACL 无权限（必须提示并落详细日志）
- `SECURITY_BLOCKED`：协议/域名/禁止模式拒绝
- `UNSUPPORTED`：暂不支持的类型
- `INTERNAL_ERROR`：未捕获异常（带追踪ID）

---

## 4. 错误处理机制

### 4.1 分层处理
- 识别/解析层：提供具体错误原因与建议（补全扩展名、检查盘符、避免非法字符）。
- 验证层：输出哪一条策略命中（协议/域名/禁止模式/ACL）。
- 路由层：若目标处理器不可用，返回 `UNSUPPORTED` 并建议替代方案。

### 4.2 Windows 权限与提示
- 发生 `PERMISSION_DENIED`：
  - UI 提示：友好文案，指明“无权限路径/文件”。
  - 日志：记录用户名/路径/ACL 检测结果/调用链摘要。
  - 建议：提供“以管理员方式打开/联系管理员授予权限”提示文本（仅文案，不实现提权）。

### 4.3 日志策略
- 访问日志：href、类型、解析耗时、结果。
- 权限日志：ACL 失败详情（不含敏感口令）。
- 错误日志：异常栈/错误码/上下文。

---

## 5. 集成方案

### 5.1 与渲染组件/前端脚本
- 复用 `markdown_processor.py` 中点击拦截与事件 `ladMarkdownLinkClick` 抛出机制。
- 在 `ContentViewer` 层监听事件 → 构造 `LinkContext` → 调用 `LinkProcessor.process_link()`。
- 对于锚点（`#id`）仍由组件内处理；仅对非锚点的链接抛出到外部。

### 5.2 与 ContentViewer（PyQt）
- 新增方法：`handle_link_action(result: LinkResult)`，根据 `action` 分派：
  - `open_browser(url)`、`open_markdown_in_tree(path)`、`open_directory(path)`、`scroll_to_anchor(id)` 等。
- 失败时：统一错误提示与日志调用。

### 5.3 与 FileResolver
- 所有本地/相对路径解析统一走 `FileResolver`，并启用 `max_size/encoding` 等既有能力（只读模式）。

### 5.4 配置加载
- `ConfigManager` 读取 `link_processing.*`，在 `LinkProcessor` 初始化时固化策略；支持热更新钩子（可选）。

### 5.5 安全与审计
- 白名单协议/域名校验在验证层执行；命中拒绝即在 WARNING 级别日志记录。
- 当 `security.allowed_domains` 为空时：默认拒绝所有外部域名访问（fail-closed），除非显式配置。
- 权限不足与解析失败归档到专门的“链接安全审计”日志通道（按现有日志体系对接）。

---

## 6. 里程碑与边界

### 6.1 第一阶段（高优先级）
1) 相对路径解析（Windows）  
2) 文件协议 `file://` 支持  
3) 链接事件路由（对接 UI）  
4) 基本错误处理（解析/不存在/策略拒绝）  
5) 安全防护（协议/域名/禁止模式）  
6) 权限处理（ACL 校验 + 友好提示 + 日志）  
7) 日志记录（访问/权限/错误）  
8) Mermaid 图表链接处理  

### 6.2 第二阶段（中优先级）
1) 链接状态管理（访问历史/已访问标记）  
2) 自动目录（TOC）生成与跳转统一  
3) 链接 UI 体验（右键菜单/工具提示）  

### 6.3 第三阶段（低优先级）
1) 统计报表/性能优化  
2) 自定义处理器/插件化  

### 6.4 TOC 与 Anchor 统一
- 目录项（TOC）统一路由至 `AnchorHandler`，保持单一路径与一致行为（等价于滚动至对应 `#id`）。

---

## 7. 约束与不做事项
- 仅 Windows；不处理跨平台差异。  
- 不做权限提升与系统策略修改，仅提示与记录。  
- 不在本阶段改动 `markdown_processor.py` 的放大/锚点内置逻辑，保持兼容。  

---

## 9. 后续迭代

### 9.1 发现的改进点（非阻塞，建议后续迭代）
- 识别器 DIRECTORY 判定目前依据尾随斜杠，后续应结合解析结果确认目标确为目录（与 PathResolver 集成后完善单测）。
- FILE_PROTOCOL 与盘符路径识别使用简化规则，后续以正则与 pathlib 校验增强，避免误判。
- LinkValidator 目前为占位：需落实 allowed_protocols、allowed_domains 与 forbidden_patterns 的严格校验与对应单测。
- 日志需接入规范化 logger，透传 `session_id`、href、type、result、error_code、elapsed_ms 等字段，统一审计。
- PathResolver 未实现：完善相对路径标准化、file:// 解析、深度与禁止模式校验，对接 FileResolver 并补足测试。

### 9.2 下一步建议（如需继续）
- 实现 PathResolver 与 LinkValidator 的最小真实逻辑（Windows 路径标准化、存在性、深度、forbidden_patterns、allowed_protocols/domains）。
- 在 LinkProcessor 中接入 logger，规范日志字段包含 `session_id` 并补充对应单测。
- 扩充 pytest：
  - xfail → 逐步变绿：权限不足、域名白名单拒绝、forbidden_patterns 命中、max_path_depth 超限。
  - 目录识别结合真实文件系统临时目录校验。
- 与 UI 对接：在 `ContentViewer` 增加 `handle_link_action` 的最小实现与测试桩，验证 open_directory/open_markdown_in_tree/scroll_to_anchor 行为衔接。

### 9.3 实施进展记录（会话ID: 2025-08-14-16-52-41 及后续）

#### 已完成的实现
- ✅ **PathResolver 最小可用版本**：
  - `resolve_relative()`: 基于当前文件解析相对路径，Windows 风格标准化
  - `resolve_file_protocol()`: 解析 file:// URL 为本地路径
  - `normalize_windows_path()`: 使用 os.path.normpath 消除冗余段

- ✅ **LinkValidator 最小可用版本**：
  - URL 校验：协议/域名白名单（fail-closed 策略）
  - 路径校验：存在性、深度限制、禁止模式、可选 ACL
  - 校验顺序：标准化 → 存在性 → 深度/禁止模式 → ACL 权限

- ✅ **日志系统增强**：
  - 集成 `logging.LoggerAdapter` 固定字段：`app`、`module_name`、`build_version`
  - 支持 JSON 和标准 `extra` 两种日志格式
  - `build_version` 来源优先级：ConfigManager → 环境变量 → pyproject.toml → 默认"dev"
  - 无依赖 pyproject.toml 解析：支持 [project] 和 [tool.poetry] 版本字段

- ✅ **单元测试覆盖**：
  - PathResolver 功能测试（相对路径、file:// 协议）
  - LinkValidator 功能测试（URL 白名单、路径验证、深度限制）
  - 日志验证测试（JSON/extra 格式、session_id、build_version 字段）
  - pyproject.toml 读取测试（正常解析、poetry fallback、异常处理）

#### 技术实现细节
- **缓存机制**：`build_version` 在 LinkProcessor 构造时缓存，避免重复解析
- **无依赖解析**：pyproject.toml 使用简单状态机解析，不引入 tomllib 依赖
- **容错设计**：各解析步骤都有异常捕获，失败时降级到下一优先级
- **测试策略**：使用 `tmp_path` 构造临时文件，模拟真实文件系统场景

#### 下一步待实现
- 与 UI 层对接：在 ContentViewer 中集成 LinkProcessor
- 完善处理器实现：RelativeMarkdownHandler、FileProtocolHandler 等
- 配置管理：从 ConfigManager 读取策略配置
- 权限处理：Windows ACL 详细校验与友好提示

（本设计文档用于实施指引，后续可按模块落地详细接口与单元测试用例。）

---

## 8. 最小单元测试清单（可直接据此编写用例）

### 8.1 识别（Recognizer）
- `#section` → ANCHOR
- `https://example.com` → EXTERNAL_HTTP
- `docs/readme.md`（相对）→ RELATIVE_MD
- `file:///C:/data/a.md` → FILE_PROTOCOL
- `images/pic.png` → IMAGE
- `graph.mmd` 或事件标记 mermaid → MERMAID（按事件 extra）
- `docs/` 或解析为目录 → DIRECTORY

### 8.2 解析（PathResolver）
- 相对路径对比基准文件解析为绝对路径（包含 `..`、盘符切换）
- `file://` URL → Windows 本地路径
- 反斜杠/正斜杠标准化结果一致

### 8.3 验证（Validator）
- 不存在路径 → NOT_FOUND
- 超深度/命中禁止模式 → SECURITY_BLOCKED
- 协议不在允许列表/域名不在白名单 → SECURITY_BLOCKED
- ACL 无权限 → PERMISSION_DENIED（含详细日志）

### 8.4 路由（Router & Handlers）
- EXTERNAL_HTTP → open_browser(url)
- RELATIVE_MD → open_markdown_in_tree(path)
- DIRECTORY → open_directory(path)
- FILE_PROTOCOL → open_markdown_in_tree(path) 或 show_error（按存在/权限）
- IMAGE → open_image_viewer(path)
- TOC/ANCHOR → scroll_to_anchor(id)

### 8.5 权限（ACL）
- 普通文件/只读目录/系统目录的访问与提示一致性
- 权限失败时 Message 友好、日志包含必要 ACL 详情

### 8.6 日志（Logging）
- 访问日志包含 `session_id`、href、类型、结果、耗时
- 策略拒绝/权限失败分级记录 WARNING/ERROR
- 异常路径有栈信息与追踪ID